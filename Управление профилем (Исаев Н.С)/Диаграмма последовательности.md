@startuml
actor Пользователь
actor "Geolocation API" as GeoAPI
actor "Сервис геокодирования" as Geocoder
participant "UI" as UI
participant "UserProfileFacade" as Facade
participant "IUserRepository" as UserRepo
participant "Database" as DB
participant "EmailService" as EmailService
participant "NotificationQueue" as NotifyQueue
participant "IAdvertisementsRepository" as AdsRepo

== Регистрация нового пользователя ==

Пользователь -> UI: Нажимает "Зарегистрироваться"
UI --> Пользователь: Показывает форму регистрации

Пользователь -> UI: Заполняет основные данные\n(имя, email, пароль)
UI -> GeoAPI: Запрос разрешения на геолокацию
GeoAPI --> Пользователь: Запрос разрешения
Пользователь --> GeoAPI: Предоставляет разрешение
GeoAPI --> UI: Геоданные (координаты)

UI -> Geocoder: geocode(coordinates)
Geocoder --> UI: {город, регион, адрес}
UI --> Пользователь: Автозаполняет поля локации

Пользователь -> UI: Корректирует адрес (при необходимости)
Пользователь -> UI: Нажимает "Зарегистрироваться"

UI -> Facade: RegisterUser(userData, location)
Facade -> UserRepo: IsEmailUnique(email)
UserRepo -> DB: SELECT COUNT(*) FROM users WHERE email = ?
DB --> UserRepo: Count
UserRepo --> Facade: true/false

alt Email уже существует
    Facade --> UI: Error: "Пользователь с таким Email уже существует"
    UI --> Пользователь: Показывает ошибку
else Данные валидны
    Facade -> UserRepo: CreateUser(userData)
    UserRepo -> DB: INSERT INTO users (values)
    DB --> UserRepo: User ID
    UserRepo --> Facade: User object
    
    Facade -> Facade: CreateUserSession(userId)
    Facade -> EmailService: SendWelcomeEmail(email, userName)
    EmailService --> Facade: Success
    
    Facade --> UI: Success: User profile + session
    UI --> Пользователь: Редирект в личный кабинет\nПоказывает сообщение об успехе
end
@enduml
